#+URL: http://nullprogram.com/blog/2014/06/13/
#+TITLE: Emacs Unicodeé™·é˜±

GNU Emacsçš„å‘å¸ƒè¦æ¯”Unicodeæ—©7å¹´ã€‚Emacså­˜åœ¨ä»¥åæ˜¯åœ¨ç›¸å¯¹è¾ƒæ™šçš„æ—¶å€™æ‰åŠ å…¥äº†å¯¹Unicodeçš„æ”¯æŒï¼Œè¿™æ„å‘³ç€åœ¨Emacsçš„å†å²ä¸­ï¼Œä¸æ”¯æŒUnicodeçš„æ—¶é—´æ®µï¼ˆ16å¹´ï¼‰æ¯”æ”¯æŒUnicodeçš„æ—¶é—´æ®µï¼ˆ14å¹´ï¼‰è¿˜è¦é•¿ã€Œæ³¨ï¼šæ–‡ç« å‘è¡¨äº2014å¹´ã€ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒEmacså¯¹Unicodeçš„æ”¯æŒååˆ†å‡ºè‰²ï¼Œè®©äººæ„Ÿè§‰ä¼¼ä¹å®ƒä¸€ç›´éƒ½æ”¯æŒUnicodeã€‚
# Emacsé¦–æ¬¡å‘å¸ƒäº1985å¹´3æœˆ
# Unicodeé¦–æ¬¡å‘å¸ƒäº1992å¹´6æœˆ
ç„¶è€Œ,ç”±äºUnicodeçš„ç›®æ ‡æ˜¯è¦æ¶µç›–æ‰€æœ‰å·²çŸ¥çš„äººç±»è¯­è¨€åŠå…¶å„å¼å„æ ·çš„ç»†ææœ«èŠ‚,ç»“æœè‡ªç„¶ä¼šå­˜åœ¨ä¸€äº›é™·é˜±å’Œé—®é¢˜ã€‚å¦‚æœä»…ä½œä¸ºä¸€ä¸ªEmacsä½¿ç”¨è€…çš„è¯ï¼Œä½ å¯èƒ½ä¸å¤ªä¼šå› æ­¤è€Œå—åˆ°å½±å“ã€‚ä½†å¦‚æœä½œä¸ºä¸€ä¸ªæ‰©å±•ï¼ˆæ’ä»¶ï¼‰çš„å¼€å‘è€…ï¼Œä½ å¾ˆå¯èƒ½ä¼šåœ¨å¤„ç†Emacsçš„stringså’Œbuffersæ—¶é‡åˆ°éº»çƒ¦ï¼Œè¿™ä¸¤ä¸ªéƒ½æ˜¯åŸºäºå­—ç¬¦çš„æ•°æ®ç»“æ„ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†åˆ†äº«Elispä¸­Unicodeå¸¦ç»™æˆ‘ä»¬çš„â€œæƒŠå–œâ€ã€‚æˆ‘è‡ªå·±å°±æ›¾é‡åˆ°è¿‡å¥½å‡ ä¸ªï¼Œäº‹å®ä¸Šï¼Œå†™è¿™ç¯‡æ–‡ç« è¿˜è®©æˆ‘åœ¨è‡ªå·±çš„æ‰©å±•ç¨‹åºä¸­å‘ç°äº†å¥½å‡ ä¸ªç¼–ç æ–¹é¢çš„å°bugã€‚è¿™äº›ç¼ºé™·éƒ½ä¸æ˜¯Emcasçš„é”™ï¼Œå®ƒä»¬åªæ˜¯è‡ªç„¶è¯­è¨€çš„å¤æ‚æ€§å¯¼è‡´çš„ç»“æœã€‚

* Unicodeå’Œç¼–ç å€¼ï¼ˆCode Pointï¼‰

é¦–å…ˆï¼Œç½‘ä¸Šæœ‰éå¸¸å¥½çš„èµ„æ–™æ¥å­¦ä¹ Unicodeï¼Œæˆ‘æ¨èä»[[http://www.cl.cam.ac.uk/~mgk25/unicode.html][UTF-8 and Unicode FAQ for Unix/Linux]]å¼€å§‹ã€‚æˆ‘æ²¡æœ‰ç†ç”±åœ¨è¿™é‡Œé‡å¤æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘ä¼šå°è¯•å¿«é€Ÿåœ°æ€»ç»“ä¸€ä¸‹ã€‚Unicodeå°†ä¸€ä¸ªç¼–ç å€¼ï¼ˆæ•´æ•°ï¼‰æ˜ å°„åˆ°æŸä¸ªå…·ä½“çš„å­—ç¬¦ï¼Œå¹¶å¸¦ä¸€ä¸ªæ ‡å‡†çš„åå­—ã€‚åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™Unicodeå®šä¹‰äº†è¶…è¿‡11ä¸‡ä¸ªçš„å­—ç¬¦ã€‚ä¸ºäº†åå‘å…¼å®¹æ€§ï¼Œå‰128ä¸ªç¼–ç å€¼æ˜ å°„åˆ°ASCIIç ã€‚è¿™ä¸ªè¶‹åŠ¿ä¹Ÿè¢«å…¶ä»–çš„å­—ç¬¦ç¼–ç æ ‡å‡†æ¥å—ï¼Œæ¯”å¦‚Latin-1ã€‚

åœ¨Emacsä¸­ï¼ŒUnicodeå­—ç¬¦ä½¿ç”¨C-x 8 RETï¼ˆinsert-charï¼‰è¾“å…¥åˆ°bufferä¸­ã€‚ä½ æ—¢å¯ä»¥è¾“å…¥æ ‡å‡†çš„å­—ç¬¦åç§°ï¼ˆæ¯”å¦‚ï¼šÏ€æ˜¯â€œGREEK SMALL LETTER PIâ€ï¼‰ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥åå…­è¿›åˆ¶çš„ç¼–ç å€¼ã€‚åœ¨Emacsä¹‹å¤–çš„å…¶ä»–åº”ç”¨ç¨‹åºä¸­å¦‚ä½•è¾“å…¥æ˜¯è¦çœ‹æƒ…å†µçš„ï¼Œä½†æ˜¯å°±æˆ‘å…³å¿ƒçš„åº”ç”¨æ¥è¯´C-S-uåŠ ä¸Šåå…­è¿›åˆ¶çš„ç¼–ç å€¼éƒ½æ˜¯å¯ä»¥çš„ã€‚

** ç¼–ç 

Unicodeæ ‡å‡†ä¹Ÿæè¿°äº†å‡ ç§æ–¹æ³•æ¥å°†ç¼–ç å€¼åºåˆ—è½¬æˆå­—èŠ‚åºåˆ—ã€‚å¾ˆæ˜æ˜¾ï¼Œ11ä¸‡ä¸ªå­—ç¬¦æ— æ³•ç”¨ä¸€ä¸ªå­—èŠ‚æ¥ç¼–ç ï¼Œæ‰€ä»¥å°±æœ‰äº†å¤šå­—èŠ‚ç¼–ç æ ¼å¼ã€‚æœ€æµè¡Œçš„ä¸¤ç§Unicodeç¼–ç æ ¼å¼åº”è¯¥æ˜¯UTF-8å’ŒUTF-16ã€‚

UTF-8è®¾è®¡ä¹‹åˆå°±æ˜¯è¦åå‘å…¼å®¹å·²å­˜åœ¨çš„ASCIIç¼–ç ã€Unixç³»ç»Ÿä»¥åŠCè¯­è¨€APIï¼ˆä»¥nullä½œä¸ºç»ˆæ­¢ç¬¦çš„Cå­—ç¬¦ä¸²ï¼‰ã€‚å‰128ä¸ªç¼–ç å€¼ç›´æ¥ç¼–ç ä¸ºå•å­—èŠ‚ï¼Œå…¶ä»–å­—ç¬¦ç”¨2åˆ°6çš„å­—èŠ‚æ¥ç¼–ç ï¼Œæ‰€æœ‰å­—èŠ‚çš„æœ€é«˜æ¯”ç‰¹è®¾ç½®ä¸º1ï¼Œè¿™æ ·æ‰€æœ‰å¤šå­—èŠ‚çš„å­—ç¬¦éƒ½ä¸ä¼šè¢«è§£é‡Šä¸ºASCIIå­—ç¬¦ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨nullï¼ˆ0ï¼‰ã€‚è¿™æ ·Cè¯­è¨€å†™çš„ç¨‹åºå’ŒAPIå°±èƒ½å¤Ÿä¸æ”¹å˜æˆ–è€…åšç¨å¾®è°ƒæ•´å°±èƒ½å¤„ç†UTF-8çš„å­—ç¬¦ä¸²äº†ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œæ¯ä¸€ä¸ªASCIIç ç¼–ç çš„æ–‡ä»¶è‡ªåŠ¨å¯ä»¥è½¬æ¢ä¸ºUTF-8ç¼–ç çš„æ–‡ä»¶ã€‚

UTF-16ç”¨2ä¸ªå­—èŠ‚æ¥ç¼–ç åŸºæœ¬å¤šæ–‡ç§å¹³é¢ï¼ˆç¬¬é›¶å¹³é¢ï¼ŒBasic Multilingual Plane - BMPï¼‰ä¸­çš„å­—ç¬¦ï¼Œç”šè‡³åŸæœ¬çš„ASCIIå­—ç¬¦ä¹Ÿç”¨2ä¸ªå­—èŠ‚ï¼ˆ16æ¯”ç‰¹ï¼‰ã€‚ç¬¬é›¶å¹³é¢åŸºæœ¬ä¸Šæ¶µç›–äº†æ‰€æœ‰ç°ä»£è¯­è¨€ä¸­å®é™…ä½¿ç”¨åˆ°çš„æ‰€æœ‰å­—ç¬¦ã€‚ç„¶è€Œ,UTF-16å´ä¸åŒ…æ‹¬è¾…åŠ©ï¼ˆæ˜Ÿä½“ï¼‰å¹³é¢ä¸­é‡è¦çš„ä¾‹å¦‚[[http://www.fileformat.info/info/unicode/char/1f379/index.htm][TROPICAL DRINK]]æˆ–è€…[[http://www.fileformat.info/info/unicode/char/1F4A9/index.htm][PILE OF POO]]å­—ç¬¦ã€‚å¦‚æœä½ éœ€è¦åœ¨UTF-16ä¸­ç”¨è¿™äº›å­—ç¬¦å°†å‡ºç°é—®é¢˜ï¼šè¶…è¿‡ç¬¬é›¶å¹³é¢çš„å­—ç¬¦ä¸èƒ½è¢«æ”¾åœ¨2ä¸ªå­—èŠ‚ä¸­ã€‚ä¸ºäº†èƒ½å®¹çº³è¿™äº›å­—ç¬¦ï¼ŒUTF-16ä½¿ç”¨ä»£ç†å¯¹ï¼ˆsurrogate pairsï¼‰ï¼šè¿™äº›å­—ç¬¦ä¼šç”¨ä¸€å¯¹2å­—èŠ‚å•å…ƒæ¥ç¼–ç ã€‚

ç”±äºæœ€åä¸€ç‚¹, UTF-16ç›¸å¯¹äºUTF-8æ²¡æœ‰å®ç”¨ä¸Šçš„ä¼˜åŠ¿ã€‚å®ƒçš„[[http://www.utf8everywhere.org/][å­˜åœ¨å¯èƒ½æ˜¯ä¸€ä¸ªå·¨å¤§çš„é”™è¯¯]]ã€‚ç”±äºä»£ç†å¯¹çš„å­˜åœ¨ï¼Œä½ æ— æ³•ç”¨æ’å®šæ—¶é—´ç®—æ³•å»æŸ¥æ‰¾ï¼Œè€Œä¸”ä¸èƒ½åå‘å…¼å®¹ä¹Ÿä¸èƒ½å­˜å‚¨åœ¨ä»¥nullç»“å°¾çš„å­—ç¬¦ä¸²ä¸­ã€‚åœ¨Javaå’ŒJavaScriptä¸­ï¼Œå®ƒä¼šå¯¼è‡´ä¸€äº›å­—ç¬¦ä¸²â€œé•¿åº¦â€å’Œå­—ç¬¦ã€ç¼–ç å€¼ç”šè‡³å­—èŠ‚æ•°ä¸ä¸€è‡³çš„çª˜å¢ƒã€‚æœ€ç³Ÿç³•çš„æ˜¯ï¼Œå®ƒä¼šå¯¼è‡´[[https://speakerdeck.com/mathiasbynens/hacking-with-unicode?slide=114][ä¸¥é‡çš„å®‰å…¨éšæ‚£]]ã€‚æ–°çš„åº”ç”¨ç¨‹åºåº”è¯¥å°½å¯èƒ½åœ°é¿å…è¿™äº›é—®é¢˜ã€‚

* Emacså’ŒUTF-8

*åœ¨Emacså†…éƒ¨æ‰€æœ‰çš„æ–‡æœ¬éƒ½ç”¨UTF-8æ ¼å¼å­˜å‚¨* ï¼Œè¿™æ˜¯ä¸ªéå¸¸æ˜æ™ºçš„é€‰æ‹©ï¼å½“Emacsè¾“å‡ºæ–‡æœ¬ï¼Œæ¯”å¦‚å†™åˆ°æ–‡ä»¶æˆ–è€…ä¼ åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼ŒEmacsä¼šè‡ªåŠ¨æ ¹æ®æ–‡ä»¶æˆ–è¿›ç¨‹æ‰€é…ç½®çš„ç¼–ç ç³»ç»Ÿæ¥å¯¹æ–‡æœ¬è¿›è¡Œç¼–ç ã€‚å½“è¯»å–ä¸€ä¸ªæ–‡ä»¶æˆ–è€…è¿›ç¨‹çš„æ–‡æœ¬æ—¶ï¼ŒEmacsè¦ä¹ˆå®ƒå°†å…¶è½¬æ¢ä¸ºUTF-8ç¼–ç æ ¼å¼ï¼Œè¦ä¹ˆä¿æŒåŸå­—èŠ‚ã€‚

å…³äºè¿™ç‚¹åœ¨Emacsä¸­æœ‰2ç§æ¨¡å¼ï¼šå•å­—èŠ‚å’Œå¤šå­—èŠ‚ã€‚å•å­—èŠ‚strings/bufferså°±æ˜¯åŸå­—èŠ‚ï¼Œå®ƒä»¬æ»¡è¶³å¸¸é‡æ—¶é—´O(1)è®¿é—®ä½†æ˜¯è¿›èƒ½ä¿å­˜å•å­—èŠ‚å€¼[[http://nullprogram.com/blog/2014/01/04/][byte-code compiler outputs unibyte strings]]ã€‚

å¤šå­—èŠ‚strings/buffersä¿å­˜UTF-8ç¼–ç çš„ç¼–ç å€¼ã€‚å­—ç¬¦è®¿é—®æ—¶é—´å¤æ‚è¯»æ˜¯O(n)å› ä¸ºéœ€è¦éå†ä¸€è¾¹string/bufferæ¥è®¡ç®—å­—ç¬¦ä¸ªæ•°ã€‚

å®é™…çš„ç¼–ç å¾ˆå°‘å…³å¿ƒï¼Œå› ä¸ºæ²¡æœ‰å¤ªå¤šæ–¹æ³•ï¼ˆå’Œéœ€è¦ï¼‰æ¥ç›´æ¥è®¿é—®ã€‚å½“æ–‡æœ¬è¾“å…¥æˆ–è¾“å‡ºæ—¶ï¼ŒEmacsä¼šè‡ªåŠ¨å°†æ–‡æœ¬ç¼–ç æ ¼å¼æŒ‰éœ€è¿›è¡Œè½¬æ¢ï¼Œæ‰€ä»¥ä¸éœ€è¦å…³å¿ƒå†…éƒ¨çš„ç¼–ç ã€‚å¦‚æœä½  /ç¡®å®/ æƒ³çŸ¥é“ï¼Œä½ å¯ä»¥ç”¨string-as-unibyteæ¥å¾—åˆ°ä»¥å­—èŠ‚è¡¨ç¤ºçš„stringã€‚

#+BEGIN_SRC emacs-lisp
  (string-as-unibyte "Ï€")
  ;; => "\317\200"
#+END_SRC

ä½¿ç”¨string-as-multibyteå¯ä»¥åå‘å°†UTF-8ç¼–ç çš„å•å­—èŠ‚stringè½¬æ¢æˆå¤šå­—èŠ‚æ–‡æœ¬ã€‚éœ€è¦æ³¨æ„è¿™ä¸¤ä¸ªå‡½æ•°ä¸string-to-unibyteå’Œstring-to-multibyteæ˜¯ä¸åŒçš„ï¼Œåè€…æ˜¯è¿›è¡Œçš„æ˜¯è½¬æ¢è€Œä¸æ˜¯ä¿æŒåŸå­—èŠ‚ã€‚

lengthå’Œbuffer-sizeå‡½æ•°æ€»æ˜¯ä½¿ç”¨multibyteè®¡ç®—å­—ç¬¦ä»¥åŠä½¿ç”¨unibyteè®¡ç®—å­—èŠ‚ã€‚ä½¿ç”¨UTF-8ï¼Œåˆ™ä¸éœ€è¦æ‹…å¿ƒä»£ç†å¯¹ã€‚string-byteså’Œposition-byteså‡½æ•°è¿”å›multibyteå’Œunibyteä¸¤ç§ç±»å‹çš„å­—èŠ‚ä¿¡æ¯ã€‚

å¦‚æœæƒ³è¦åœ¨å­—ç¬¦ä¸²ä¸­æŒ‡å®šUnicodeå­—ç¬¦è€Œåˆä¸ç›´æ¥ä½¿ç”¨å­—ç¬¦ï¼Œå¯ä»¥ç”¨\uXXXXã€‚XXXXæ˜¯è¯¥å­—ç¬¦çš„åå…­è¿›åˆ¶ç¼–ç å€¼ï¼Œé•¿åº¦æ€»æ˜¯4ã€‚å¯¹äºç¬¬é›¶å¹³é¢å¤–çš„å­—ç¬¦ï¼Œ4ä¸ªå­—ç¬¦ä¸å¤Ÿï¼Œè¦ä½¿ç”¨å¤§å†™çš„UåŠ ä¸Š8ä½æ•°å­—ï¼š\UXXXXXXXXã€‚

#+BEGIN_SRC emacs-lisp
  "\u03C0"
  ;; => "Ï€"

  "\U0001F4A9"
  ;; => "ğŸ’©"  (PILE OF POO)
#+END_SRC

æœ€åï¼ŒEmacså¯¹Unicodeè¿›è¡Œäº†æ‰©å±•ï¼Œå¢åŠ äº†256ä¸ªé¢å¤–çš„â€œå­—ç¬¦â€æ¥è¡¨ç¤ºåŸå­—èŠ‚ã€‚è¿™æ ·å…è®¸è‡ªå¸¦çš„åŸå­—èŠ‚ä¸UTF-8åºåˆ—ä¸åŒã€‚ä¾‹å¦‚ï¼Œå®ƒå¯ä»¥ç”¨æ¥åŒºåˆ«ç¼–ç å€¼U+0041å’ŒåŸå­—èŠ‚#x41ã€‚è¦æˆ‘è¯´çš„è¯ï¼Œè¿™ä¸å¤ªå¸¸ç”¨ã€‚

* ç»„åˆå­—ç¬¦ï¼ˆCombining Charactersï¼‰

æœ‰äº›Unicodeå­—ç¬¦å®šä¹‰ä¸ºç»„åˆå­—ç¬¦ã€‚è¿™äº›å­—ç¬¦çš„ä½œç”¨æ˜¯ä¿®æ”¹å®ƒå‰é¢çš„éç»„åˆå­—ç¬¦ï¼Œå…¸å‹ä½œç”¨æ˜¯åŠ é‡æˆ–è€…å˜éŸ³æ ‡è®°ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå•è¯â€œnaÃ¯veâ€å¯ä»¥å†™ä½œè¿™6ä¸ªå­—ç¬¦"nai\u0308ve"ã€‚ç¬¬4ä¸ªå­—ç¬¦U+0308ï¼ˆç»„åˆåˆ†éŸ³ç¬¦ï¼‰å°±æ˜¯ä¸€ä¸ªç»„åˆå­—ç¬¦ï¼Œç”¨æ¥å°†â€œiâ€ (U+0069 LATIN SMALL LETTER I)å˜æˆä¸€ä¸ªå˜éŸ³å­—ç¬¦ã€‚

é€šå¸¸çš„åŠ é‡å­—ç¬¦ä¹Ÿæœ‰å®ƒè‡ªå·±çš„ç¼–ç å€¼ï¼Œå«åšé¢„ç»„åˆå­—ç¬¦ï¼ˆprecomposed charactersï¼‰ï¼ŒåŒ…æ‹¬Ã¯ (U+00EF LATIN SMALL LETTER I WITH DIAERESIS)ã€‚æ‰€ä»¥â€œnaÃ¯veâ€ä¹Ÿå¯ä»¥å†™ä½œè¿™5ä¸ªå­—ç¬¦"na\u00EFve"ã€‚

** å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰

é‚£ä¹ˆæ¯”è¾ƒä¸¤ä¸ªä¸¤ä¸ªä¸åŒè¡¨ç¤ºçš„å­—ç¬¦ä¼šç»“æœå¦‚ä½•å‘¢ï¼Ÿ

ä¸ç›¸ç­‰ã€‚

#+BEGIN_SRC emacs-lisp
  (string= "nai\u0308ve" "na\u00EFve")
  ;; => nil
#+END_SRC

ä¸ºäº†åº”å¯¹è¿™ç§æƒ…å†µï¼ŒUnicodeæ ‡å‡†å®šä¹‰äº†4ç§ä¸åŒçš„å½’ä¸€åŒ–ã€‚å…¶ä¸­æœ€é‡è¦çš„ä¸¤ç§æ˜¯NFCï¼ˆç»„åˆï¼‰å’ŒNFDï¼ˆåˆ†è§£ï¼‰ã€‚å‰è€…å°½å¯èƒ½åœ°ä½¿ç”¨é¢„ç»„åˆå­—ç¬¦è€Œåè€…å°½å¯èƒ½åœ°å°†å…¶æ‹†åˆ†ã€‚ucs-normalize-NFC-stringå’Œucs-normalize-NFD-stringå‡½æ•°ç”¨æ¥å®ç°è¿™ä¸¤ä¸ªæ“ä½œã€‚

*é™·é˜±æç¤º#1ï¼š åŠ¡å¿…å…ˆè¿›è¡Œå½’ä¸€åŒ–å†è¿›è¡Œå­—ç¬¦ä¸²æ¯”è¾ƒã€‚*  ä¸ç®¡ä½¿ç”¨å“ªç§å½’ä¸€åŒ–ï¼ˆNFDè¦ç¨å¾®å¿«ä¸€ç‚¹ï¼‰ï¼Œä½†éœ€è¦ä¸€è‡´ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå½“ä½ æ¯”è¾ƒå¤æ‚çš„å¤šå­—ç¬¦ä¸²æ—¶ä¾ç„¶å¯èƒ½äº§ç”Ÿå¥‡æ€ªçš„ç»“æœã€‚

#+BEGIN_SRC emacs-lisp
  (string= (ucs-normalize-NFD-string "nai\u0308ve")
           (ucs-normalize-NFD-string "na\u00EFve"))
  ;; => t
#+END_SRC

ç”¨Emacsè‡ªå¸¦çš„å‡½æ•°æ¯”è¾ƒä¼šå¤±è´¥ï¼Œå®ƒåœ¨ä½¿ç”¨internå‡½æ•°å‰ä¸ä¼šåšå½’ä¸€åŒ–ï¼Œä¹Ÿè®¸è¿™æ˜¯ä¸ªé”™è¯¯ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„åç§°ï¼ˆinternè½¬æ¢çš„canonical symbolï¼‰æ¥å®šä¹‰ä¸åŒçš„å˜é‡å’Œå‡½æ•°ã€‚

#+BEGIN_SRC emacs-lisp
  (eq (intern "nai\u0308ve")
      (intern "na\u00EFve"))
  ;; => nil

  (defun print-rÃ©sumÃ© ()
    "NFC-normalized form."
    (print "I'm going to sabotage your team."))

  (defun print-reÌsumeÌ ()
    "NFD-normalized form."
    (print "I'd be a great asset to your team."))

  (print-rÃ©sumÃ©)
  ;; => "I'm going to sabotage your team."
#+END_SRC

** å­—ç¬¦ä¸²å®½åº¦

æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥ç”¨æ¥è®¡ç®—å¤šå­—èŠ‚æ–‡æœ¬çš„æ•°é‡ï¼Œé€šå¸¸å®ƒä»¬çš„å€¼ç›¸åŒï¼Œä½†æ˜¯åœ¨æœ‰äº›æƒ…å†µä¸‹å®ƒä»¬å´å„ä¸ä¸åŒã€‚

  * é•¿åº¦ï¼š å­—ç¬¦ä¸ªæ•°ï¼ŒåŒ…æ‹¬ç»„åˆå­—ç¬¦
  * å­—èŠ‚æ•°ï¼š ç”¨UTF-8ç¼–ç çš„å­—èŠ‚æ•°
  * å®½åº¦ï¼š å å½“å‰ç¼“å†²åŒºçš„åˆ—æ•°

å¤§å¤šæ•°æ—¶å€™ï¼Œä¸€ä¸ªå­—ç¬¦å°±æ˜¯ä¸€åˆ—ï¼ˆä¸€ä¸ªå­—ç¬¦çš„å®½åº¦ï¼‰ã€‚æœ‰ä¸€äº›å­—ç¬¦ï¼Œæ¯”å¦‚ç»„åˆå­—ç¬¦ï¼Œä¸å ç”¨å®½åº¦ã€‚ä¸€äº›äºšæ´²å›½å®¶å­—ç¬¦å ä¸¤åˆ—ï¼Œæ¯”å¦‚(U+4000, ä€€)ã€‚Tabå ç”¨tab-widthåˆ—ï¼Œé€šå¸¸æ˜¯8ã€‚

é€šå¸¸æ¥è¯´ï¼Œä¸ç®¡ä½¿ç”¨NFDæˆ–è€…NFCï¼Œå­—ç¬¦ä¸²çš„å®½åº¦æ˜¯ä¸€æ ·çš„ã€‚ç„¶è€Œï¼Œç”±äºbugå’Œå¯¹Unicodeçš„æ”¯æŒä¸å®Œæ•´ï¼Œè¿™ä¸ªè¯´æ³•ä¸æ˜¯å®Œå…¨æ­£ç¡®ã€‚ä¾‹å¦‚ï¼Œæœ‰äº›ç»„åˆå­—ç¬¦ï¼Œå¦‚U+20DD, âƒ  åœ¨Emacsä¸­æˆ–è€…å…¶ä»–åº”ç”¨ç¨‹åºä¸­æ— æ³•æ­£ç¡®åœ°ç»„åˆã€‚

*é™·é˜±æç¤º#2ï¼š å½“å±•ç¤ºä¸€ä¸ªbufferæ—¶ï¼ŒåŠ¡å¿…ä½¿ç”¨å®½åº¦è€Œä¸æ˜¯é•¿åº¦æ¥è®¡ç®—æ–‡æœ¬ã€‚*  å®½åº¦é€šè¿‡string-widthå‡½æ•°æ¥è®¡ç®—ï¼Œå½“å±•ç¤ºbufferä¸­çš„è¡¨æ ¼çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ã€‚æ¯åˆ—ä¸­é€‚å½“çš„å­—ç¬¦ä¸ªæ•°è¦æ ¹æ®æ˜¯ä»€ä¹ˆå­—ç¬¦è€Œå®šã€‚

å¹¸è¿çš„æ˜¯ï¼Œæœ‰æ¬¡ç¢°å·§é€šè¿‡[[http://nullprogram.com/blog/2013/09/04/][Elfeed]]å¾—åˆ°äº†æ­£ç¡®ç»“æœï¼Œå› ä¸ºæˆ‘ä½¿ç”¨äº†formatå‡½æ•°æ¥å±•ç¤ºã€‚å¦‚å¸Œæœ›åœ°é‚£æ ·ï¼Œ%sæŒ‡ç¤ºç¬¦ç”¨æ¥æ“ä½œå®½åº¦ã€‚ç„¶è€Œæœ‰ä¸ªå‰¯ä½œç”¨ï¼šå¾ˆå¤šæ ¼å¼åŒ–çš„è¾“å‡ºä¼šæ ¹æ®å½“å‰bufferè€Œæ”¹å˜ï¼ *é™·é˜±æç¤º#3ï¼š ä½¿ç”¨formatå‡½æ•°æ—¶åŠ¡å¿…æ³¨æ„å½“å‰bufferã€‚*

#+BEGIN_SRC emacs-lisp
  (let ((tab-width 4))
    (length (format "%.6s" "\t")))
  ;; => 1

  (let ((tab-width 8))
    (length (format "%.6s" "\t")))
  ;; => 0
#+END_SRC

** å­—ç¬¦ä¸²åè½¬

åŠ å…¥è¦å°†ä¸€ä¸ªå¤šå­—èŠ‚å­—ç¬¦ä¸²åè½¬ã€‚å¾ˆç®€å•ï¼Œå¯¹å—ï¼Ÿ

#+BEGIN_SRC emacs-lisp
  (defun reverse-string (string)
    (concat (reverse (string-to-list string))))

  (reverse-string "abc")
  ;; => "cba"
#+END_SRC

é”™äº†ï¼ç»„åˆå­—ç¬¦ç»åè½¬ä¼šå¯¹ä¹‹å‰å®ƒå³è¾¹çš„å­—ç¬¦è¿›è¡Œä¿®æ”¹è€Œäº§ç”Ÿé”™è¯¯ã€‚

#+BEGIN_SRC emacs-lisp
  (reverse-string "nai\u0308ve")
  ;; => "evÌˆian"
#+END_SRC

*Pitfall #4: [[https://github.com/mathiasbynens/esrever][Unicodeå­—ç¬¦ä¸²åè½¬åŠ¡å¿…å°å¿ƒ]]ã€‚* [[http://rosettacode.org/wiki/Reverse_a_string][Rosetta Code]] é¡µé¢ç½—åˆ—äº†è®¸å¤šé”™è¯¯çš„æ¡ˆä¾‹ï¼Œ [[http://nullprogram.com/blog/2012/11/15/][æˆ‘ä¸ªäººä¹Ÿå‡ºè¿‡é”™]] ã€‚ä¹‹åæˆ‘[[https://github.com/magnars/s.el/pull/58][æäº¤äº†ä¸€ä¸ªs.elçš„è¡¥ä¸]] æ¥ä¿®æ­£Unicodeçš„s-reverseå‡½æ•°ã€‚
å¦‚æœè¿™ä¸ªèƒ½è¢«æ¥å—ï¼Œä½ å°±ä¸ç”¨å†æ‹…å¿ƒè¿™ä¸ªäº†ã€‚

** æ­£åˆ™è¡¨è¾¾å¼

æ­£åˆ™è¡¨è¾¾å¼åŸºäºç¼–ç å€¼ã€‚ç»„åˆå­—ç¬¦å•ç‹¬è®¡ç®—ï¼ŒåŒ¹é…ä¼šæ ¹æ®å­—ç¬¦å¦‚ä½•ç»„åˆå¯èƒ½ä¸ä¸åŒã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œä½ éœ€è¦åœ¨åšæŸäº›æ­£åˆ™åŒ¹é…ä¹‹å‰è¿›è¡ŒNFCå½’ä¸€åŒ–ã€‚

#+BEGIN_SRC emacs-lisp
  ;; Like string= from before:
  (string-match-p  "na\u00EFve" "nai\u0308ve")
  ;; => nil

  ;; Use NFC normilization
  (string-match-p (ucs-normalize-NFC-string "na\u00EFve") 
                  (ucs-normalize-NFC-string "nai\u0308ve"))
  ;; => 0

  ;; The . only matches part of the composition
  (string-match-p "na.ve" "nai\u0308ve")
  ;; => nil
  
  ;; .. matches i and the composition character
  (string-match-p "na..ve" "nai\u0308ve")
  ;; => 0

#+END_SRC

*é™·é˜±æç¤º#5ï¼š ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ—¶åŠ¡å¿…æ³¨æ„ç»„åˆå­—ç¬¦ï¼Œä¸”ä¼˜å…ˆé€‰æ‹©NFCå½’ä¸€åŒ–ã€‚*

å¦ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜æ˜¯èŒƒå›´ï¼Œå°½ç®¡è¿™ä¸å¤ªå¸¸è§ã€‚å­—ç¬¦çš„èŒƒå›´å¯ä»¥ç”¨ä¸­æ‹¬å·æ¥è¡¨è¾¾ï¼Œæ¯”å¦‚[a-zA-Z]ã€‚å¦‚æœèŒƒå›´ä»¥åˆ†è§£çš„ç»„åˆå­—ç¬¦å¼€å§‹æˆ–ç»“æŸï¼Œå°†å¾—ä¸åˆ°æ­£ç¡®çš„ç»“æœï¼Œå› ä¸ºç»„åˆå­—ç¬¦éƒ¨åˆ†ä¼šè¢«æ­£åˆ™è¡¨è¾¾å¼å¼•æ“å•ç‹¬å¤„ç†ã€‚

#+BEGIN_SRC emacs-lisp
  (defvar match-weird "[\u00E0-\u00F6]+")

  (string-match-p match-weird "Ã¡Ã¢Ã£Ã¤Ã¥")
  ;; => 0  (successful match)

  (string-match-p (ucs-normalize-NFD-string match-weird) "Ã¡Ã¢Ã£Ã¤Ã¥")
  ;; => nil
#+END_SRC

åœ¨å®¡æŸ¥ä¸€äº›ä¸å—ä¿¡ä»»çš„è¾“å…¥æ—¶å°†æ‰€æœ‰è¿™äº›ç‰¢è®°äºå¿ƒæ˜¯éå¸¸é‡è¦çš„ï¼Œæ¯”å¦‚ä½¿ç”¨Emacsä½œä¸ºWeb serverï¼Œæ”»å‡»è€…å¯èƒ½ä½¿ç”¨éå½’ä¸€åŒ–æˆ–å¥‡æ€ªçš„å­—ç¬¦ä¸²æ¥ç»•å¼€è¿‡æ»¤å™¨ã€‚
* Interacting with the World

Hereâ€™s a mistake Iâ€™ve made twice now. Emacs uses UTF-8 internally, regardless
of whatever encoding the original text came in. 
Pitfall #6: *When working with bytes of text, the counts may be different than the original source of the text*.

For example, HTTP/1.1 introduced persistent connections. Before this, a client
connects to a server and asks for content. The server sends the content and
then closes the connection to signal the end of the data. In HTTP/1.1, when
Connection: close isnâ€™t specified, the server will instead send a
Content-Length header indicating the length of the content in bytes. The
connection can then be re-used for more requests, or, more importantly,
pipelining requests.

The main problem is that HTTP headers usually have a different encoding than
the content body. Emacs is not prepared to handle multiple encodings from a
single source, so the only correct way to talk HTTP with a network process is
raw. My mistake was allowing Emacs to do the UTF-8 conversion, then measuring
the length of the content in its UTF-8 encoding. This just happens to work
fine about 99.9% of the time since clients tend to speak UTF-8, or something
like it, anyway, but itâ€™s not correct.

* Further Reading

A lot of this investigation was inspired by JavaScriptâ€™s and other languagesâ€™
Unicode shortcomings.

  * [[http://www.cl.cam.ac.uk/~mgk25/unicode.html][UTF-8 and Unicode FAQ for Unix/Linux]]
  * [[https://speakerdeck.com/mathiasbynens/hacking-with-unicode][Hacking with Unicode]]
  * [[https://github.com/mathiasbynens/jsesc][jsesc]]
  * [[http://docs.oracle.com/javase/7/docs/api/java/lang/Character.html#unicode][java.lang.Character Unicode Character Representations]]
  * [[http://www.gnu.org/software/emacs/manual/html_node/elisp/Strings-and-Characters.html][GNU Emacs Lisp Reference Manual: Strings and Characters]]

Comparatively, Emacs Lisp has really great Unicode support. This isnâ€™t too
surprising considering that itâ€™s primary purpose is for manipulating text.
